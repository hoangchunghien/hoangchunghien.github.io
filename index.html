<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.svg">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hienhoang.ml","root":"/","images":"/images","scheme":"Gemini","version":"8.0.2","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="https://hienhoang.ml/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Hien Hoang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hienhoang.ml/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>


  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MNVCW6TJVQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-MNVCW6TJVQ');
  </script>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Hien Hoang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">86</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hoangchunghien" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hoangchunghien" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hoangchunghien@gmail.com" title="E-Mail → mailto:hoangchunghien@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/hoangchunghien" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;hoangchunghien" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hienhoang.ml/2021/04/21/Image-Semantic-Segmentation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Hien Hoang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/21/Image-Semantic-Segmentation/" class="post-title-link" itemprop="url">Image Semantic Segmentation</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-21 16:17:20" itemprop="dateCreated datePublished" datetime="2021-04-21T16:17:20+07:00">2021-04-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-24 14:20:44" itemprop="dateModified" datetime="2021-04-24T14:20:44+07:00">2021-04-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Machine-Learning/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="overview">1. Overview</h1>
<p><img src="https://www.robots.ox.ac.uk/~vgg/data/pets/pet_annotations.jpg"></p>
<p>Source: https://www.robots.ox.ac.uk/~vgg/data/pets/</p>
<h1 id="fully-convolution-network-fcn">2. Fully Convolution Network (FCN)</h1>
<h2 id="dataset">2.1. Dataset</h2>
<p>In this example, I will use <code>Oxford-IIIT Pet</code> dataset. We can access it by using <code>tensorflow-datasets</code> package.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install tensorflow-datasets</span><br></pre></td></tr></table></figure>
<p>Now load the data</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow_datasets <span class="keyword">as</span> tfds</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">dataset, info = tfds.load(<span class="string">&#x27;oxford_iiit_pet&#x27;</span>, with_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">TRAIN_SIZE = info.splits[<span class="string">&#x27;train&#x27;</span>].num_examples</span><br><span class="line">VALIDATION_SIZE = info.splits[<span class="string">&#x27;test&#x27;</span>].num_examples</span><br><span class="line"></span><br><span class="line">BATCH_SIZE = <span class="number">32</span></span><br><span class="line">BUFFER_SIZE = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize</span>(<span class="params">input_image, input_mask</span>):</span></span><br><span class="line">    input_image = tf.cast(input_image, tf.float32) / <span class="number">255.0</span></span><br><span class="line">    input_mask -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> input_image, input_mask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_image</span>(<span class="params">dataset_element</span>):</span></span><br><span class="line">    input_image = tf.image.resize(dataset_element[<span class="string">&#x27;image&#x27;</span>], (<span class="number">256</span>, <span class="number">256</span>))</span><br><span class="line">    input_mask = tf.image.resize(dataset_element[<span class="string">&#x27;segmentation_mask&#x27;</span>], (<span class="number">256</span>, <span class="number">256</span>))</span><br><span class="line">    input_image, input_mask = normalize(input_image, input_mask)</span><br><span class="line">    <span class="keyword">return</span> input_image, input_mask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train_dataset = (dataset[<span class="string">&#x27;train&#x27;</span>]</span><br><span class="line">                 .<span class="built_in">map</span>(load_image, num_parallel_calls=tf.data.experimental.AUTOTUNE)</span><br><span class="line">                 .shuffle(BUFFER_SIZE)</span><br><span class="line">                 .batch(BATCH_SIZE)</span><br><span class="line">                 .prefetch(tf.data.experimental.AUTOTUNE))</span><br><span class="line"></span><br><span class="line">test_dataset = (dataset[<span class="string">&#x27;test&#x27;</span>]</span><br><span class="line">                .<span class="built_in">map</span>(load_image, num_parallel_calls=tf.data.experimental.AUTOTUNE)</span><br><span class="line">                .batch(BATCH_SIZE))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="define-the-model">2.2. Define the model</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line">inputs = tf.keras.layers.Input(shape=(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>))</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">64</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block1_conv1&#x27;</span>)(inputs)</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">64</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&quot;relu&quot;</span>, </span><br><span class="line">    padding=<span class="string">&quot;same&quot;</span>, </span><br><span class="line">    name=<span class="string">&quot;block1_conv2&quot;</span>)(x)</span><br><span class="line">x = tf.keras.layers.MaxPooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>), strides=<span class="number">2</span>, name=<span class="string">&#x27;block1_pool&#x27;</span>)(x)</span><br><span class="line"></span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">128</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block2_conv1&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">128</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block2_conv2&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.MaxPooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>), strides=<span class="number">2</span>, name=<span class="string">&#x27;block2_pool&#x27;</span>)(x)</span><br><span class="line"></span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">256</span>,</span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block3_conv1&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">256</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block3_conv2&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">256</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block3_conv3&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.MaxPooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>), strides=<span class="number">2</span>, name=<span class="string">&#x27;block3_pool&#x27;</span>)(x)</span><br><span class="line">block3_pool = x</span><br><span class="line"></span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">512</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block4_conv1&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">512</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block4_conv2&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">512</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block4_conv3&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.MaxPooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>), strides=<span class="number">2</span>, name=<span class="string">&#x27;block4_pool&#x27;</span>)(x)</span><br><span class="line">block4_pool = x</span><br><span class="line"></span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">512</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block5_conv1&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">512</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block5_conv2&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">512</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;block5_conv3&#x27;</span>)(x)</span><br><span class="line">x = tf.keras.layers.MaxPooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>), strides=<span class="number">2</span>, name=<span class="string">&#x27;block5_pool&#x27;</span>)(x)</span><br><span class="line">block5_pool = x</span><br><span class="line"></span><br><span class="line">outputs = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">3</span>, </span><br><span class="line">    kernel_size=(<span class="number">7</span>, <span class="number">7</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;conv6&#x27;</span>)(block5_pool)</span><br><span class="line">conv6_4 = tf.keras.layers.Conv2DTranspose(</span><br><span class="line">    filters=<span class="number">3</span>, </span><br><span class="line">    kernel_size=(<span class="number">4</span>, <span class="number">4</span>), </span><br><span class="line">    strides=<span class="number">4</span>, </span><br><span class="line">    use_bias=<span class="literal">False</span>)(outputs)</span><br><span class="line"></span><br><span class="line">pool4_n = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">3</span>, </span><br><span class="line">    kernel_size=(<span class="number">1</span>, <span class="number">1</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;pool4_n&#x27;</span>)(block4_pool)</span><br><span class="line">pool4_n_2 = tf.keras.layers.Conv2DTranspose(</span><br><span class="line">    filters=<span class="number">3</span>, </span><br><span class="line">    kernel_size=(<span class="number">2</span>, <span class="number">2</span>), </span><br><span class="line">    strides=<span class="number">2</span>, </span><br><span class="line">    use_bias=<span class="literal">False</span>)(pool4_n)</span><br><span class="line"></span><br><span class="line">pool3_n = tf.keras.layers.Conv2D(</span><br><span class="line">    filters=<span class="number">3</span>, </span><br><span class="line">    kernel_size=(<span class="number">3</span>, <span class="number">3</span>), </span><br><span class="line">    activation=<span class="string">&#x27;relu&#x27;</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    name=<span class="string">&#x27;pool3_n&#x27;</span>)(block3_pool)</span><br><span class="line"></span><br><span class="line">output = tf.keras.layers.Add(name=<span class="string">&#x27;add&#x27;</span>)([pool4_n_2, pool3_n, conv6_4])</span><br><span class="line">output = tf.keras.layers.Conv2DTranspose(filters=<span class="number">3</span>, kernel_size=(<span class="number">8</span>, <span class="number">8</span>), strides=<span class="number">8</span>, use_bias=<span class="literal">False</span>)(output)</span><br><span class="line">output = tf.keras.layers.Softmax()(output)</span><br><span class="line"></span><br><span class="line">fcn_model = tf.keras.models.Model(inputs, output)</span><br><span class="line"></span><br><span class="line">fcn_model.<span class="built_in">compile</span>(</span><br><span class="line">    loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=<span class="literal">True</span>), </span><br><span class="line">    optimizer=tf.keras.optimizers.RMSprop(), </span><br><span class="line">    metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line"></span><br><span class="line">fcn_model.summary()</span><br></pre></td></tr></table></figure>
<p>In this step, we use <code>SparseCategoricalCrossentropy</code> as loss function for pixel classification task. The output channels here are 3 because each pixel can be categorized into one of three classes.</p>
<p>The network summary</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Model: &quot;functional<span class="emphasis">_1&quot;</span></span><br><span class="line"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">Layer (type)                    Output Shape         Param #     Connected to                     </span></span></span><br><span class="line"><span class="emphasis"><span class="strong">==================================================================================================</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">input<span class="emphasis">_2 (InputLayer)            [(None, 256, 256, 3) 0                                            </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block1<span class="emphasis">_conv1 (Conv2D)           (None, 256, 256, 64) 1792        input_</span>2[<span class="string">0</span>][<span class="symbol">0</span>]                    </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block1_</span>conv2 (Conv2D)           (None, 256, 256, 64) 36928       block1<span class="emphasis">_conv1[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block1<span class="emphasis">_pool (MaxPooling2D)      (None, 128, 128, 64) 0           block1_</span>conv2[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block2_</span>conv1 (Conv2D)           (None, 128, 128, 128 73856       block1<span class="emphasis">_pool[<span class="string">0</span>][<span class="symbol">0</span>]                </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block2<span class="emphasis">_conv2 (Conv2D)           (None, 128, 128, 128 147584      block2_</span>conv1[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block2_</span>pool (MaxPooling2D)      (None, 64, 64, 128)  0           block2<span class="emphasis">_conv2[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block3<span class="emphasis">_conv1 (Conv2D)           (None, 64, 64, 256)  295168      block2_</span>pool[<span class="string">0</span>][<span class="symbol">0</span>]                </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block3_</span>conv2 (Conv2D)           (None, 64, 64, 256)  590080      block3<span class="emphasis">_conv1[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block3<span class="emphasis">_conv3 (Conv2D)           (None, 64, 64, 256)  590080      block3_</span>conv2[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block3_</span>pool (MaxPooling2D)      (None, 32, 32, 256)  0           block3<span class="emphasis">_conv3[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block4<span class="emphasis">_conv1 (Conv2D)           (None, 32, 32, 512)  1180160     block3_</span>pool[<span class="string">0</span>][<span class="symbol">0</span>]                </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block4_</span>conv2 (Conv2D)           (None, 32, 32, 512)  2359808     block4<span class="emphasis">_conv1[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block4<span class="emphasis">_conv3 (Conv2D)           (None, 32, 32, 512)  2359808     block4_</span>conv2[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block4_</span>pool (MaxPooling2D)      (None, 16, 16, 512)  0           block4<span class="emphasis">_conv3[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block5<span class="emphasis">_conv1 (Conv2D)           (None, 16, 16, 512)  2359808     block4_</span>pool[<span class="string">0</span>][<span class="symbol">0</span>]                </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block5_</span>conv2 (Conv2D)           (None, 16, 16, 512)  2359808     block5<span class="emphasis">_conv1[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">block5<span class="emphasis">_conv3 (Conv2D)           (None, 16, 16, 512)  2359808     block5_</span>conv2[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">block5_</span>pool (MaxPooling2D)      (None, 8, 8, 512)    0           block5<span class="emphasis">_conv3[<span class="string">0</span>][<span class="symbol">0</span>]               </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">pool4<span class="emphasis">_n (Conv2D)                (None, 16, 16, 3)    1539        block4_</span>pool[<span class="string">0</span>][<span class="symbol">0</span>]                </span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">conv6 (Conv2D)                  (None, 8, 8, 3)      75267       block5_</span>pool[<span class="string">0</span>][<span class="symbol">0</span>]                </span></span></span><br><span class="line"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span><br><span class="line"><span class="emphasis">conv2d_</span>transpose<span class="emphasis">_1 (Conv2DTrans (None, 32, 32, 3)    36          pool4_</span>n[<span class="string">0</span>][<span class="symbol">0</span>]                    </span><br><span class="line"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span><br><span class="line"><span class="strong">pool3<span class="emphasis">_n (Conv2D)                (None, 32, 32, 3)    6915        block3_</span>pool[<span class="string">0</span>][<span class="symbol">0</span>]                </span></span><br><span class="line"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span><br><span class="line">conv2d<span class="emphasis">_transpose (Conv2DTranspo (None, 32, 32, 3)    144         conv6[<span class="string">0</span>][<span class="symbol">0</span>]                      </span></span><br><span class="line"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">add (Add)                       (None, 32, 32, 3)    0           conv2d<span class="emphasis">_transpose_</span>1[<span class="string">0</span>][<span class="symbol">0</span>]         </span></span></span><br><span class="line"><span class="emphasis"><span class="strong">                                                                 pool3<span class="emphasis">_n[<span class="string">0</span>][<span class="symbol">0</span>]                    </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">                                                                 conv2d_</span>transpose[<span class="string">0</span>][<span class="symbol">0</span>]           </span></span></span><br><span class="line"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span><br><span class="line"><span class="emphasis">conv2d_</span>transpose<span class="emphasis">_2 (Conv2DTrans (None, 256, 256, 3)  576         add[<span class="string">0</span>][<span class="symbol">0</span>]                        </span></span><br><span class="line"><span class="emphasis"><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">__</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">softmax (Softmax)               (None, 256, 256, 3)  0           conv2d<span class="emphasis">_transpose_</span>2[<span class="string">0</span>][<span class="symbol">0</span>]         </span></span></span><br><span class="line"><span class="emphasis"><span class="strong">==================================================================================================</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">Total params: 14,799,165</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">Trainable params: 14,799,165</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">Non-trainable params: 0</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">__</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span><span class="strong">____</span></span></span><br></pre></td></tr></table></figure>
<h2 id="training">2.3. Training</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">model_checkpoint_callback = tf.keras.callbacks.ModelCheckpoint(</span><br><span class="line">    filepath=<span class="string">&#x27;./model.best.hdf5&#x27;</span>, </span><br><span class="line">    save_weights_only=<span class="literal">False</span>, </span><br><span class="line">    save_best_only=<span class="literal">True</span>,</span><br><span class="line">    monitor=<span class="string">&#x27;val_loss&#x27;</span>)</span><br><span class="line"></span><br><span class="line">hist = fcn_model.fit(</span><br><span class="line">    train_dataset, </span><br><span class="line">    epochs=<span class="number">120</span>,  </span><br><span class="line">    validation_data=test_dataset, </span><br><span class="line">    callbacks=[model_checkpoint_callback])</span><br></pre></td></tr></table></figure>
<h2 id="experiment">2.4. Experiment</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_mask</span>(<span class="params">prediction_mask</span>):</span></span><br><span class="line">    prediction_mask = tf.argmax(prediction_mask, axis=<span class="number">-1</span>)</span><br><span class="line">    prediction_mask = prediction_mask[..., tf.newaxis]</span><br><span class="line">    <span class="keyword">return</span> prediction_mask</span><br><span class="line"></span><br><span class="line">batch = <span class="built_in">next</span>(<span class="built_in">iter</span>(test_dataset))</span><br><span class="line">results = fcn_model.predict(batch)</span><br><span class="line">images, masks = batch</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> image, mask, result <span class="keyword">in</span> <span class="built_in">zip</span>(images, masks, results):</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    image = tf.keras.preprocessing.image.array_to_img(image)</span><br><span class="line">    mask = tf.keras.preprocessing.image.array_to_img(mask)</span><br><span class="line">    output = tf.keras.preprocessing.image.array_to_img(create_mask(result))</span><br><span class="line">    </span><br><span class="line">    image.save(<span class="string">f&#x27;image.<span class="subst">&#123;i:<span class="number">02</span>d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    mask.save(<span class="string">f&#x27;mask.<span class="subst">&#123;i:<span class="number">02</span>d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    output.save(<span class="string">f&#x27;output.<span class="subst">&#123;i:<span class="number">02</span>d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>Some results</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Raw Image</th>
<th>Ground truth</th>
<th>Predicted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><img src="/images/2021-04-21/image.01.jpg" /></td>
<td><img src="/images/2021-04-21/mask.01.jpg" /></td>
<td><img src="/images/2021-04-21/output.01.jpg" /></td>
</tr>
<tr class="even">
<td>2</td>
<td><img src="/images/2021-04-21/image.02.jpg" /></td>
<td><img src="/images/2021-04-21/mask.02.jpg" /></td>
<td><img src="/images/2021-04-21/output.02.jpg" /></td>
</tr>
<tr class="odd">
<td>3</td>
<td><img src="/images/2021-04-21/image.03.jpg" /></td>
<td><img src="/images/2021-04-21/mask.03.jpg" /></td>
<td><img src="/images/2021-04-21/output.03.jpg" /></td>
</tr>
<tr class="even">
<td>4</td>
<td><img src="/images/2021-04-21/image.04.jpg" /></td>
<td><img src="/images/2021-04-21/mask.04.jpg" /></td>
<td><img src="/images/2021-04-21/output.04.jpg" /></td>
</tr>
</tbody>
</table>
<p>Read more about FCN <a target="_blank" rel="noopener" href="https://arxiv.org/abs/1411.4038">here</a></p>
<h1 id="u-net">3. U-Net</h1>
<h2 id="dataset-1">3.1. Dataset</h2>
<p>I will use the same dataset <code>Oxford-IIIT Pet</code> in this example.</p>
<h2 id="define-the-model-1">3.2. Define the model</h2>
<p>We will need some building block</p>
<ul>
<li>Down sampling block use normal convolution to down sample it inputs</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">down_sample</span>(<span class="params">filters, kernel_size, batch_norm=<span class="literal">True</span></span>):</span></span><br><span class="line">    initializer = tf.random_normal_initializer(<span class="number">0.0</span>, <span class="number">0.02</span>)</span><br><span class="line">    layers = tf.keras.Sequential()</span><br><span class="line">    layers.add(tf.keras.layers.Conv2D(</span><br><span class="line">        filters=filters, </span><br><span class="line">        kernel_size=kernel_size, </span><br><span class="line">        strides=<span class="number">2</span>, </span><br><span class="line">        padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">        kernel_initializer=initializer, </span><br><span class="line">        use_bias=<span class="literal">False</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> batch_norm:</span><br><span class="line">        layers.add(tf.keras.layers.BatchNormalization())</span><br><span class="line">    </span><br><span class="line">    layers.add(tf.keras.layers.LeakyReLU())</span><br><span class="line">    <span class="keyword">return</span> layers</span><br></pre></td></tr></table></figure>
<ul>
<li>Up sampling block use transpose convolution to up sample it inputs</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">up_sample</span>(<span class="params">filters, kernel_size, dropout=<span class="literal">False</span></span>):</span></span><br><span class="line">    initializer = tf.random_normal_initializer(<span class="number">0.0</span>, <span class="number">0.02</span>)</span><br><span class="line">    layers = tf.keras.Sequential()</span><br><span class="line">    layers.add(tf.keras.layers.Conv2DTranspose(</span><br><span class="line">        filters=filters, </span><br><span class="line">        kernel_size=kernel_size, </span><br><span class="line">        strides=<span class="number">2</span>, </span><br><span class="line">        padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">        kernel_initializer=initializer, </span><br><span class="line">        use_bias=<span class="literal">False</span>)</span><br><span class="line">    )</span><br><span class="line">    layers.add(tf.keras.layers.BatchNormalization())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> dropout:</span><br><span class="line">        layers.add(tf.keras.layers.Dropout(<span class="number">0.5</span>))</span><br><span class="line">    </span><br><span class="line">    layers.add(tf.keras.layers.ReLU())</span><br><span class="line">    <span class="keyword">return</span> layers</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>Construct the U-Net model</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">down_stack = [down_sample(<span class="number">64</span>, <span class="number">4</span>, batch_norm=<span class="literal">False</span>)]</span><br><span class="line"><span class="keyword">for</span> filters <span class="keyword">in</span> [<span class="number">128</span>, <span class="number">256</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>]:</span><br><span class="line">    down_stack.append(down_sample(filters, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">up_stack = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    up_stack.append(up_sample(<span class="number">512</span>, <span class="number">4</span>, dropout=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> filters <span class="keyword">in</span> [<span class="number">512</span>, <span class="number">256</span>, <span class="number">128</span>, <span class="number">64</span>]:</span><br><span class="line">    up_stack.append(up_sample(filters, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inputs = tf.keras.layers.Input(shape=(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>))</span><br><span class="line">x = inputs</span><br><span class="line">skip_layers = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> down <span class="keyword">in</span> down_stack:</span><br><span class="line">    x = down(x)</span><br><span class="line">    skip_layers.append(x)</span><br><span class="line"></span><br><span class="line">skip_layers = <span class="built_in">reversed</span>(skip_layers[:<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># We use skip connection to avoid vanishing gradient problem</span></span><br><span class="line"><span class="keyword">for</span> up, skip_connection <span class="keyword">in</span> <span class="built_in">zip</span>(up_stack, skip_layers):</span><br><span class="line">    x = up(x)</span><br><span class="line">    x = tf.keras.layers.Concatenate()([x, skip_connection])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N_CLASSES = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">initializer = tf.random_normal_initializer(<span class="number">0.0</span>, <span class="number">0.02</span>)</span><br><span class="line">outputs = tf.keras.layers.Conv2DTranspose(</span><br><span class="line">    filters=N_CLASSES, </span><br><span class="line">    kernel_size=<span class="number">3</span>, </span><br><span class="line">    strides=<span class="number">2</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    kernel_initializer=initializer)(x)</span><br><span class="line"></span><br><span class="line">model = tf.keras.models.Model(inputs=inputs, outputs=outputs)</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=<span class="literal">True</span>), </span><br><span class="line">    optimizer=tf.keras.optimizers.RMSprop(), </span><br><span class="line">    metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h2 id="training-1">3.3. Training</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">model_checkpoint_callback = tf.keras.callbacks.ModelCheckpoint(</span><br><span class="line">    filepath=<span class="string">&#x27;./unet.&#123;val_loss:.9f&#125;.hdf5&#x27;</span>, </span><br><span class="line">    save_weights_only=<span class="literal">False</span>, </span><br><span class="line">    save_best_only=<span class="literal">True</span>,</span><br><span class="line">    monitor=<span class="string">&#x27;val_loss&#x27;</span>)</span><br><span class="line"></span><br><span class="line">model.fit(train_dataset, epochs=<span class="number">50</span>, validation_data=test_dataset, callbacks=[model_checkpoint_callback])</span><br></pre></td></tr></table></figure>
<h2 id="experiment-1">3.4. Experiment</h2>
<p>Some results</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Raw Image</th>
<th>Ground truth</th>
<th>Predicted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><img src="/images/2021-04-21/unet_image.01.jpg" /></td>
<td><img src="/images/2021-04-21/unet_mask.01.jpg" /></td>
<td><img src="/images/2021-04-21/unet_output.01.jpg" /></td>
</tr>
<tr class="even">
<td>2</td>
<td><img src="/images/2021-04-21/unet_image.02.jpg" /></td>
<td><img src="/images/2021-04-21/unet_mask.02.jpg" /></td>
<td><img src="/images/2021-04-21/unet_output.02.jpg" /></td>
</tr>
<tr class="odd">
<td>3</td>
<td><img src="/images/2021-04-21/unet_image.03.jpg" /></td>
<td><img src="/images/2021-04-21/unet_mask.03.jpg" /></td>
<td><img src="/images/2021-04-21/unet_output.03.jpg" /></td>
</tr>
<tr class="even">
<td>4</td>
<td><img src="/images/2021-04-21/unet_image.04.jpg" /></td>
<td><img src="/images/2021-04-21/unet_mask.04.jpg" /></td>
<td><img src="/images/2021-04-21/unet_output.04.jpg" /></td>
</tr>
</tbody>
</table>
<h2 id="how-it-works">3.5. How it works?</h2>
<p>To understand more about vanishing gradient, click <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vanishing_gradient_problem">here</a></p>
<p>Read more about <a target="_blank" rel="noopener" href="https://arxiv.org/abs/1505.04597">U-Net</a></p>
<h1 id="u-net-with-pretrain">4. U-Net With Pretrain</h1>
<h2 id="dataset-2">4.1. Dataset</h2>
<p>I will use the same dataset <code>Oxford-IIIT Pet</code> in this example.</p>
<h2 id="define-model">4.2. Define model</h2>
<ul>
<li>The pretrain model <a target="_blank" rel="noopener" href="https://keras.io/api/applications/mobilenet/#mobilenetv2-function">MobileNetV2</a> will be used in this example.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">pretrain_model = tf.keras.applications.MobileNetV2(</span><br><span class="line">    input_shape=(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>), </span><br><span class="line">    include_top=<span class="literal">False</span>, </span><br><span class="line">    weights=<span class="string">&#x27;imagenet&#x27;</span>)</span><br><span class="line"></span><br><span class="line">target_values = [</span><br><span class="line">    <span class="string">&#x27;block_1_expand_relu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;block_3_expand_relu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;block_6_expand_relu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;block_13_expand_relu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;block_16_project&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">layers = [pretrain_model.get_layer(layer).output <span class="keyword">for</span> layer <span class="keyword">in</span> target_values]</span><br><span class="line"></span><br><span class="line">down_stack = tf.keras.models.Model(inputs=pretrain_model.<span class="built_in">input</span>, outputs=layers)</span><br><span class="line">down_stack.trainable = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">up_stack = []</span><br><span class="line"><span class="keyword">for</span> filters <span class="keyword">in</span> [<span class="number">512</span>, <span class="number">256</span>, <span class="number">128</span>, <span class="number">64</span>]:</span><br><span class="line">    up_stack.append(up_sample(filters, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">inputs = tf.keras.layers.Input(shape=(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>))</span><br><span class="line">x = inputs</span><br><span class="line"></span><br><span class="line">skip_layers = down_stack(x)</span><br><span class="line"></span><br><span class="line">x = skip_layers[<span class="number">-1</span>]</span><br><span class="line">skip_layers = <span class="built_in">reversed</span>(skip_layers[:<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> up, skip_connection <span class="keyword">in</span> <span class="built_in">zip</span>(up_stack, skip_layers):</span><br><span class="line">    x = up(x)</span><br><span class="line">    x = tf.keras.layers.Concatenate()([x, skip_connection])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N_CLASSES = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">initializer = tf.random_normal_initializer(<span class="number">0.0</span>, <span class="number">0.02</span>)</span><br><span class="line">outputs = tf.keras.layers.Conv2DTranspose(</span><br><span class="line">    filters=N_CLASSES, </span><br><span class="line">    kernel_size=<span class="number">3</span>, </span><br><span class="line">    strides=<span class="number">2</span>, </span><br><span class="line">    padding=<span class="string">&#x27;same&#x27;</span>, </span><br><span class="line">    kernel_initializer=initializer)(x)</span><br><span class="line"></span><br><span class="line">model = tf.keras.models.Model(inputs=inputs, outputs=outputs)</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(</span><br><span class="line">    loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=<span class="literal">True</span>), </span><br><span class="line">    optimizer=tf.keras.optimizers.RMSprop(), </span><br><span class="line">    metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h2 id="training-2">4.3. Training</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">model_checkpoint_callback = tf.keras.callbacks.ModelCheckpoint(</span><br><span class="line">    filepath=<span class="string">&#x27;./unet.pretrain.&#123;val_loss:.9f&#125;.hdf5&#x27;</span>, </span><br><span class="line">    save_weights_only=<span class="literal">False</span>, </span><br><span class="line">    save_best_only=<span class="literal">True</span>,</span><br><span class="line">    monitor=<span class="string">&#x27;val_loss&#x27;</span>)</span><br><span class="line"></span><br><span class="line">hist = model.fit(</span><br><span class="line">    train_dataset, </span><br><span class="line">    epochs=<span class="number">50</span>, </span><br><span class="line">    validation_data=test_dataset, </span><br><span class="line">    callbacks=[model_checkpoint_callback])</span><br></pre></td></tr></table></figure>
<h2 id="experiment-2">4.4. Experiment</h2>
<p>Some results</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Raw Image</th>
<th>Ground truth</th>
<th>Predicted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><img src="/images/2021-04-21/image.01.jpg" /></td>
<td><img src="/images/2021-04-21/mask.01.jpg" /></td>
<td><img src="/images/2021-04-21/pretrain_output.01.jpg" /></td>
</tr>
<tr class="even">
<td>2</td>
<td><img src="/images/2021-04-21/image.02.jpg" /></td>
<td><img src="/images/2021-04-21/mask.02.jpg" /></td>
<td><img src="/images/2021-04-21/pretrain_output.02.jpg" /></td>
</tr>
<tr class="odd">
<td>3</td>
<td><img src="/images/2021-04-21/image.03.jpg" /></td>
<td><img src="/images/2021-04-21/mask.03.jpg" /></td>
<td><img src="/images/2021-04-21/pretrain_output.03.jpg" /></td>
</tr>
<tr class="even">
<td>4</td>
<td><img src="/images/2021-04-21/image.04.jpg" /></td>
<td><img src="/images/2021-04-21/mask.04.jpg" /></td>
<td><img src="/images/2021-04-21/pretrain_output.04.jpg" /></td>
</tr>
</tbody>
</table>
<h1 id="mask-rcnn">5. Mask-RCNN</h1>
<h2 id="load-pretrain-model-from-tensorflow-hub">5.1. Load pretrain model from tensorflow hub</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow_hub <span class="keyword">as</span> hub</span><br><span class="line"></span><br><span class="line">MODEL_PATH = (<span class="string">&#x27;https://tfhub.dev/tensorflow/mask_rcnn/inception_resnet_v2_1024x1024/1&#x27;</span>)</span><br><span class="line">mask_rcnn = hub.load(MODEL_PATH)</span><br></pre></td></tr></table></figure>
<h2 id="install-visualization-utils-from-tensorflow-models">5.2. Install visualization utils from tensorflow models</h2>
<ul>
<li>Shell script</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone –-depth 1 https://github.com/tensorflow/models</span><br><span class="line">sudo apt install -y protobuf-compiler</span><br><span class="line">cd models/research</span><br><span class="line">protoc object_detection/protos/*.proto --python_out=.</span><br><span class="line">cp object_detection/packages/tf2/setup.py .</span><br><span class="line">python -m pip install -q .</span><br></pre></td></tr></table></figure>
<ul>
<li>Import visualization package</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> ops</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> visualization_utils <span class="keyword">as</span> viz</span><br><span class="line"><span class="keyword">from</span> object_detection.utils.label_map_util <span class="keyword">import</span> create_category_index_from_labelmap</span><br></pre></td></tr></table></figure>
<h2 id="experiment-3">5.3. Experiment</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">results = mask_rcnn(image)</span><br><span class="line">model_output = &#123;k: v.numpy() <span class="keyword">for</span> k, v <span class="keyword">in</span> results.items()&#125;</span><br><span class="line"></span><br><span class="line">detection_masks = model_output[<span class="string">&#x27;detection_masks&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">detection_masks = tf.convert_to_tensor(detection_masks)</span><br><span class="line"></span><br><span class="line">detection_boxes = model_output[<span class="string">&#x27;detection_boxes&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">detection_boxes = tf.convert_to_tensor(detection_boxes)</span><br><span class="line"></span><br><span class="line">detection_masks_reframed = ops.reframe_box_masks_to_image_masks(</span><br><span class="line">    detection_masks, </span><br><span class="line">    detection_boxes, </span><br><span class="line">    image.shape[<span class="number">1</span>], </span><br><span class="line">    image.shape[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">detection_masks_reframed = tf.cast(detection_masks_reframed &gt; <span class="number">0.5</span>, tf.uint8)</span><br><span class="line"></span><br><span class="line">model_output[<span class="string">&#x27;detection_masks_reframed&#x27;</span>] = detection_masks_reframed.numpy()</span><br><span class="line"></span><br><span class="line">boxes = model_output[<span class="string">&#x27;detection_boxes&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">classes = model_output[<span class="string">&#x27;detection_classes&#x27;</span>][<span class="number">0</span>].astype(<span class="string">&#x27;int&#x27;</span>)</span><br><span class="line">scores = model_output[<span class="string">&#x27;detection_scores&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">masks = model_output[<span class="string">&#x27;detection_masks_reframed&#x27;</span>]</span><br><span class="line"></span><br><span class="line">image_with_mask = image.copy()</span><br><span class="line">viz.visualize_boxes_and_labels_on_image_array(</span><br><span class="line">    image=image_with_mask[<span class="number">0</span>], </span><br><span class="line">    boxes=boxes,</span><br><span class="line">    classes=classes,</span><br><span class="line">    scores=scores,</span><br><span class="line">    category_index=CATEGORY_IDX,</span><br><span class="line">    use_normalized_coordinates=<span class="literal">True</span>,</span><br><span class="line">    max_boxes_to_draw=<span class="number">200</span>,</span><br><span class="line">    min_score_thresh=<span class="number">0.30</span>,</span><br><span class="line">    agnostic_mode=<span class="literal">False</span>,</span><br><span class="line">    instance_masks=masks,</span><br><span class="line">    line_thickness=<span class="number">5</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">24</span>, <span class="number">32</span>))</span><br><span class="line">plt.imshow(image_with_mask[<span class="number">0</span>])</span><br><span class="line">plt.savefig(<span class="string">f&#x27;maskrcnn_output.jpg&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Some results</li>
</ul>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Raw Image</th>
<th>Ground truth</th>
<th>Predicted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><img src="/images/2021-04-21/image.01.jpg" /></td>
<td><img src="/images/2021-04-21/mask.01.jpg" /></td>
<td><img width="256" height="256" src="/images/2021-04-21/maskrcnn_output.01.jpg" /></td>
</tr>
<tr class="even">
<td>2</td>
<td><img src="/images/2021-04-21/image.02.jpg" /></td>
<td><img src="/images/2021-04-21/mask.02.jpg" /></td>
<td><img width="256" height="256" src="/images/2021-04-21/maskrcnn_output.02.jpg" /></td>
</tr>
<tr class="odd">
<td>3</td>
<td><img src="/images/2021-04-21/image.03.jpg" /></td>
<td><img src="/images/2021-04-21/mask.03.jpg" /></td>
<td><img width="256" height="256" src="/images/2021-04-21/maskrcnn_output.03.jpg" /></td>
</tr>
<tr class="even">
<td>4</td>
<td><img src="/images/2021-04-21/image.04.jpg" /></td>
<td><img src="/images/2021-04-21/mask.04.jpg" /></td>
<td><img width="256" height="256" src="/images/2021-04-21/maskrcnn_output.04.jpg" /></td>
</tr>
</tbody>
</table>
<h2 id="see-also">5.4. See also</h2>
<ul>
<li>https://tfhub.dev/tensorflow/mask_rcnn/inception_resnet_v2_1024x1024/1</li>
<li>https://arxiv.org/abs/1703.06870</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hienhoang.ml/2021/04/17/Encode-your-image-using-Autoencoders/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Hien Hoang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/17/Encode-your-image-using-Autoencoders/" class="post-title-link" itemprop="url">Encode image using Autoencoders</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-17 18:27:26" itemprop="dateCreated datePublished" datetime="2021-04-17T18:27:26+07:00">2021-04-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-19 22:18:52" itemprop="dateModified" datetime="2021-04-19T22:18:52+07:00">2021-04-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Machine-Learning/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="overview">1. Overview</h1>
<blockquote><p>An autoencoder is a type of artificial neural network used to learn efficient data codings in an unsupervised manner. The aim of an autoencoder is to learn a representation (encoding) for a set of data, typically for dimensionality reduction, by training the network to ignore signal “noise”. Along with the reduction side, a reconstructing side is learned, where the autoencoder tries to generate from the reduced encoding a representation as close as possible to its original input, hence its name.</p>
<footer><strong>Wiki</strong><cite><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Autoencoder">en.wikipedia.org/wiki/Autoencoder</a></cite></footer></blockquote>
<p><img height="320" src="https://upload.wikimedia.org/wikipedia/commons/2/28/Autoencoder_structure.png"></p>
<h1 id="create-a-simple-autoencoder">2. Create a simple autoencoder</h1>
<h2 id="dataset">2.1. Dataset</h2>
<p>In this simple example, I will use <a target="_blank" rel="noopener" href="https://www.kaggle.com/zalando-research/fashionmnist">Fashion-MNIST</a> dataset. <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.keras.datasets <span class="keyword">import</span> fashion_mnist</span><br></pre></td></tr></table></figure></p>
<h2 id="define-model">2.2. Define model</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line">INPUT_DIM = <span class="number">784</span></span><br><span class="line">ENCODE_DIM = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">inputs = tf.keras.layers.Input(shape=(INPUT_DIM,))</span><br><span class="line">encoder = tf.keras.layers.Dense(units=<span class="number">512</span>)(inputs)</span><br><span class="line">encoder = tf.keras.layers.ReLU()(encoder)</span><br><span class="line">encoder = tf.keras.layers.Dense(units=<span class="number">256</span>)(encoder)</span><br><span class="line">encoder = tf.keras.layers.ReLU()(encoder)</span><br><span class="line">encoder = tf.keras.layers.Dense(ENCODE_DIM)(encoder)</span><br><span class="line"></span><br><span class="line">encoding = tf.keras.layers.ReLU()(encoder)</span><br><span class="line"></span><br><span class="line">decoder = tf.keras.layers.Dense(units=<span class="number">256</span>)(encoding)</span><br><span class="line">decoder = tf.keras.layers.ReLU()(decoder)</span><br><span class="line">decoder = tf.keras.layers.Dense(units=<span class="number">512</span>)(decoder)</span><br><span class="line">decoder = tf.keras.layers.ReLU()(decoder)</span><br><span class="line">decoder = tf.keras.layers.Dense(units=INPUT_DIM)(decoder)</span><br><span class="line">outputs = tf.keras.layers.Activation(<span class="string">&#x27;sigmoid&#x27;</span>)(decoder)</span><br><span class="line"></span><br><span class="line">model = tf.keras.models.Model(inputs=inputs, outputs=outputs)</span><br></pre></td></tr></table></figure>
<h2 id="training">2.3. Training</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We use only the image data</span></span><br><span class="line">(X_train, _), (X_test, _) = fashion_mnist.load_data()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Normalize</span></span><br><span class="line">X_train = X_train.astype(<span class="string">&#x27;float32&#x27;</span>) / <span class="number">255.0</span></span><br><span class="line">X_test = X_test.astype(<span class="string">&#x27;float32&#x27;</span>) / <span class="number">255.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reshape to (?, 768)</span></span><br><span class="line">X_train = X_train.reshape((X_train.shape[<span class="number">0</span>], <span class="number">-1</span>))</span><br><span class="line">X_test = X_test.reshape((X_test.shape[<span class="number">0</span>], <span class="number">-1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile the model</span></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>, loss=<span class="string">&#x27;mse&#x27;</span>)</span><br><span class="line"></span><br><span class="line">EPOCHS = <span class="number">300</span></span><br><span class="line">BATCH_SIZE = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">model.fit(</span><br><span class="line">    X_train, X_train, </span><br><span class="line">    epochs=EPOCHS, </span><br><span class="line">    batch_size=BATCH_SIZE, </span><br><span class="line">    shuffle=<span class="literal">True</span>, </span><br><span class="line">    validation_data=(X_test, X_test))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="evaluation">2.4. Evaluation</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">predictions = model.predict(X_test)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">plt.imshow(predictions[<span class="number">0</span>].reshape((<span class="number">28</span>, <span class="number">28</span>)), cmap=<span class="string">&quot;gray&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Few experiment results</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Raw Image</th>
<th>Generated</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><img src="/images/2021-04-18/raw_001.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/gen_001.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>2</td>
<td><img src="/images/2021-04-18/raw_002.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/gen_002.png" width="64" height="64" /></td>
</tr>
<tr class="odd">
<td>3</td>
<td><img src="/images/2021-04-18/raw_003.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/gen_003.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>4</td>
<td><img src="/images/2021-04-18/raw_004.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/gen_004.png" width="64" height="64" /></td>
</tr>
<tr class="odd">
<td>5</td>
<td><img src="/images/2021-04-18/raw_005.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/gen_005.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>6</td>
<td><img src="/images/2021-04-18/raw_006.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/gen_006.png" width="64" height="64" /></td>
</tr>
<tr class="odd">
<td>7</td>
<td><img src="/images/2021-04-18/raw_007.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/gen_007.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>8</td>
<td><img src="/images/2021-04-18/raw_008.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/gen_008.png" width="64" height="64" /></td>
</tr>
</tbody>
</table>
<h2 id="how-it-works">2.5. How it works</h2>
<ul>
<li>The encoder take raw input of size <code>768</code> and compress the input to the size of <code>128</code>.</li>
<li>The decoder take compressed input of size <code>128</code> and decode it to the size of <code>768</code>.</li>
<li>The training process is to minimize to error distance between raw inputs and generated outputs.</li>
</ul>
<h1 id="create-a-cnn-autoencoder">3. Create a CNN autoencoder</h1>
<h2 id="dataset-1">3.1. Dataset</h2>
<p>I use <a target="_blank" rel="noopener" href="https://www.kaggle.com/mengcius/cinic10">CINIC-10</a> in this example.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line">train_paths = glob.glob(<span class="string">&#x27;inputs/train/*/*.png&#x27;</span>)</span><br><span class="line">valid_paths = glob.glob(<span class="string">&#x27;inputs/valid/*/*.png&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_img</span>(<span class="params">img_path</span>):</span></span><br><span class="line">    image = tf.io.read_file(img_path)</span><br><span class="line">    image = tf.image.decode_jpeg(image, channels=<span class="number">3</span>)</span><br><span class="line">    image = tf.image.convert_image_dtype(image, np.float32)</span><br><span class="line">    image = image / <span class="number">255.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> image, image</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prepare dataset</span></span><br><span class="line">train_dataset = (tf.data.Dataset</span><br><span class="line">                 .from_tensor_slices(train_paths)</span><br><span class="line">                 .shuffle(<span class="number">1024</span>).<span class="built_in">map</span>(load_img)</span><br><span class="line">                 .batch(<span class="number">128</span>)</span><br><span class="line">                 .prefetch(<span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">valid_dataset = (tf.data.Dataset</span><br><span class="line">                 .from_tensor_slices(valid_paths)</span><br><span class="line">                 .<span class="built_in">map</span>(load_img)</span><br><span class="line">                 .batch(<span class="number">128</span>)</span><br><span class="line">                 .prefetch(<span class="number">1024</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="define-model-1">3.2. Define model</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ENCODING_DIM = <span class="number">256</span></span><br><span class="line"></span><br><span class="line">input_layer = tf.keras.layers.Input(shape=(<span class="number">128</span>, <span class="number">128</span>, <span class="number">3</span>))</span><br><span class="line">encoder = tf.keras.layers.Conv2D(filters=<span class="number">32</span>, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), strides=<span class="number">2</span>, padding=<span class="string">&#x27;same&#x27;</span>)(input_layer)</span><br><span class="line">encoder = tf.keras.layers.LeakyReLU(alpha=<span class="number">0.2</span>)(encoder)</span><br><span class="line">encoder = tf.keras.layers.BatchNormalization()(encoder)</span><br><span class="line"></span><br><span class="line">encoder = tf.keras.layers.Conv2D(filters=<span class="number">64</span>, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), strides=<span class="number">2</span>, padding=<span class="string">&#x27;same&#x27;</span>)(encoder)</span><br><span class="line">encoder = tf.keras.layers.LeakyReLU(alpha=<span class="number">0.2</span>)(encoder)</span><br><span class="line">encoder = tf.keras.layers.BatchNormalization()(encoder)</span><br><span class="line"></span><br><span class="line">encoder_output_shape = encoder.shape</span><br><span class="line">encoder = tf.keras.layers.Flatten()(encoder)</span><br><span class="line">encoder_output = tf.keras.layers.Dense(ENCODING_DIM)(encoder)</span><br><span class="line">encoder_model = tf.keras.models.Model(inputs=input_layer, outputs=encoder_output)</span><br><span class="line"></span><br><span class="line">decoder_input = tf.keras.layers.Input(shape=(ENCODING_DIM,))</span><br><span class="line">target_shape = <span class="built_in">tuple</span>(encoder_output_shape[<span class="number">1</span>:])</span><br><span class="line">decoder = tf.keras.layers.Dense(np.prod(target_shape))(decoder_input)</span><br><span class="line">decoder = tf.keras.layers.Reshape(target_shape)(decoder)</span><br><span class="line"></span><br><span class="line">decoder = tf.keras.layers.Conv2DTranspose(filters=<span class="number">64</span>, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), strides=<span class="number">2</span>, padding=<span class="string">&#x27;same&#x27;</span>)(decoder)</span><br><span class="line">decoder = tf.keras.layers.LeakyReLU(alpha=<span class="number">0.2</span>)(decoder)</span><br><span class="line">decoder = tf.keras.layers.BatchNormalization()(decoder)</span><br><span class="line"></span><br><span class="line">decoder = tf.keras.layers.Conv2DTranspose(filters=<span class="number">32</span>, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), strides=<span class="number">2</span>, padding=<span class="string">&#x27;same&#x27;</span>)(decoder)</span><br><span class="line">decoder = tf.keras.layers.LeakyReLU(alpha=<span class="number">0.2</span>)(decoder)</span><br><span class="line">decoder = tf.keras.layers.BatchNormalization()(decoder)</span><br><span class="line"></span><br><span class="line">decoder = tf.keras.layers.Conv2DTranspose(filters=<span class="number">3</span>, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), padding=<span class="string">&#x27;same&#x27;</span>)(decoder)</span><br><span class="line">outputs = tf.keras.layers.Activation(<span class="string">&#x27;sigmoid&#x27;</span>)(decoder)</span><br><span class="line"></span><br><span class="line">decoder_model = tf.keras.models.Model(inputs=decoder_input, outputs=outputs)</span><br><span class="line"></span><br><span class="line">encoder_model_outputs = encoder_model(input_layer)</span><br><span class="line">decoder_model_outputs = decoder_model(encoder_model_outputs)</span><br><span class="line">autoencoder_model = tf.keras.models.Model(inputs=input_layer, outputs=decoder_model_outputs)</span><br><span class="line"></span><br><span class="line">autoencoder_model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>, loss=<span class="string">&#x27;mse&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="training-1">3.3. Training</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">model_checkpoint_callback = tf.keras.callbacks.ModelCheckpoint(</span><br><span class="line">    filepath=<span class="string">&#x27;./model.&#123;epoch:02d&#125;-&#123;val_loss:.9f&#125;.hdf5&#x27;</span>, </span><br><span class="line">    save_weights_only=<span class="literal">False</span>, </span><br><span class="line">    save_best_only=<span class="literal">True</span>,</span><br><span class="line">    monitor=<span class="string">&#x27;val_loss&#x27;</span>)</span><br><span class="line"></span><br><span class="line">autoencoder_model.fit(</span><br><span class="line">    train_dataset, </span><br><span class="line">    validation_data=valid_dataset, </span><br><span class="line">    epochs=<span class="number">300</span>, </span><br><span class="line">    callbacks=[model_checkpoint_callback])</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="evaluation-1">3.4. Evaluation</h2>
<p>To save your training time, use can use my pretrain model. <a href="/images/2021-04-18/model.cinic.hdf5">Download</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">autoencoder_model = tf.keras.models.load_model(<span class="string">&#x27;model.cinic.hdf5&#x27;</span>)</span><br><span class="line">predictions = autoencoder_model.predict(valid_dataset)</span><br></pre></td></tr></table></figure>
<p>Few experiment results</p>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Raw Image</th>
<th>Generated</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><img src="/images/2021-04-18/cnn_raw_001.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/cnn_gen_001.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>2</td>
<td><img src="/images/2021-04-18/cnn_raw_002.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/cnn_gen_002.png" width="64" height="64" /></td>
</tr>
<tr class="odd">
<td>3</td>
<td><img src="/images/2021-04-18/cnn_raw_003.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/cnn_gen_003.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>4</td>
<td><img src="/images/2021-04-18/cnn_raw_004.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/cnn_gen_004.png" width="64" height="64" /></td>
</tr>
<tr class="odd">
<td>5</td>
<td><img src="/images/2021-04-18/cnn_raw_005.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/cnn_gen_005.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>6</td>
<td><img src="/images/2021-04-18/cnn_raw_006.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/cnn_gen_006.png" width="64" height="64" /></td>
</tr>
<tr class="odd">
<td>7</td>
<td><img src="/images/2021-04-18/cnn_raw_007.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/cnn_gen_007.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>8</td>
<td><img src="/images/2021-04-18/cnn_raw_008.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/cnn_gen_008.png" width="64" height="64" /></td>
</tr>
</tbody>
</table>
<h2 id="how-it-works-1">3.5. How it works</h2>
<ul>
<li><p>The encoder use <code>Conv2D</code> to encode the raw image of size <code>32x32x3</code> (RGB channel) into a encoding vector of size <code>256</code>.</p></li>
<li><p>The decoder use <code>Conv2DTranspose</code> to decode the encoding vector into a output image of size <code>32x32x3</code>. Learn more about Conv2DTranspose <a target="_blank" rel="noopener" href="https://towardsdatascience.com/types-of-convolutions-in-deep-learning-717013397f4d">here</a>. <img src="https://miro.medium.com/max/790/1*Lpn4nag_KRMfGkx1k6bV-g.gif" /></p></li>
</ul>
<h1 id="create-an-inverse-image-search-index">4. Create an inverse image search index</h1>
<h2 id="index-the-cinic-10-dataset">4.1. Index the <code>CINIC-10</code> dataset</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">euclidean_dist</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> np.linalg.norm(x - y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">index_dataset = (tf.data.Dataset</span><br><span class="line">                 .from_tensor_slices(train_paths)</span><br><span class="line">                 .<span class="built_in">map</span>(load_img)</span><br><span class="line">                 .batch(<span class="number">1</span>)</span><br><span class="line">                 .prefetch(<span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">features = encoder_model.predict(index_dataset)</span><br><span class="line"></span><br><span class="line">search_index = &#123;</span><br><span class="line">    <span class="string">&#x27;features&#x27;</span>: features,</span><br><span class="line">    <span class="string">&#x27;dataset&#x27;</span>: index_dataset</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span>(<span class="params">query_vector, search_index, max_results=<span class="number">8</span></span>):</span></span><br><span class="line">    vectors = search_index[<span class="string">&#x27;features&#x27;</span>]</span><br><span class="line">    results = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, (image, _) <span class="keyword">in</span> <span class="built_in">enumerate</span>(search_index[<span class="string">&#x27;dataset&#x27;</span>]):</span><br><span class="line">        distance = euclidean_dist(query_vector, vectors[i])</span><br><span class="line">        results.append((distance, image.numpy()))</span><br><span class="line">    </span><br><span class="line">    results = <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> p: p[<span class="number">0</span>])[:max_results]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="experiment">4.2. Experiment</h2>
<table>
<thead>
<tr class="header">
<th>ID</th>
<th>Query Image</th>
<th>Results</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><img src="/images/2021-04-18/query_001.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/search_001.png" width="64" height="64" /> <img src="/images/2021-04-18/search_002.png" width="64" height="64" /> <img src="/images/2021-04-18/search_003.png" width="64" height="64" /> <img src="/images/2021-04-18/search_004.png" width="64" height="64" /> <img src="/images/2021-04-18/search_005.png" width="64" height="64" /> <img src="/images/2021-04-18/search_006.png" width="64" height="64" /> <img src="/images/2021-04-18/search_007.png" width="64" height="64" /> <img src="/images/2021-04-18/search_008.png" width="64" height="64" /></td>
</tr>
<tr class="even">
<td>2</td>
<td><img src="/images/2021-04-18/query_002.png" width="64" height="64" /></td>
<td><img src="/images/2021-04-18/search_2001.png" width="64" height="64" /> <img src="/images/2021-04-18/search_2002.png" width="64" height="64" /> <img src="/images/2021-04-18/search_2003.png" width="64" height="64" /> <img src="/images/2021-04-18/search_2004.png" width="64" height="64" /> <img src="/images/2021-04-18/search_2005.png" width="64" height="64" /> <img src="/images/2021-04-18/search_2006.png" width="64" height="64" /> <img src="/images/2021-04-18/search_2007.png" width="64" height="64" /> <img src="/images/2021-04-18/search_2008.png" width="64" height="64" /></td>
</tr>
</tbody>
</table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hienhoang.ml/2021/03/14/How-to-tech-computer-to-play-Tictactoe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Hien Hoang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/14/How-to-tech-computer-to-play-Tictactoe/" class="post-title-link" itemprop="url">How to teach computer to play Tictactoe</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-03-14 13:21:08" itemprop="dateCreated datePublished" datetime="2021-03-14T13:21:08+07:00">2021-03-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-18 11:34:09" itemprop="dateModified" datetime="2021-04-18T11:34:09+07:00">2021-04-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Reinforcement-Learning/" itemprop="url" rel="index"><span itemprop="name">Reinforcement Learning</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>What make people become good game players? They get the game instruction, start practicing and then learn from failure. How about a computer? Can we train it to play a game? The answer is absolutely! And the process of teaching or training the computer to play game is super interesting. This post is written to guide you, step by step, to create your own Game AI that is able to learn to play this game without any hardcoded rules. Let's try teaching the computer yourself, after about a hundred thousands episodes, it can become expert that you can hardly win. In addition, if you would like to know more how it actually works, keep scrolling down to read further til the end of the post.</p>
<iframe src="http://tictactoe.hienhoang.ml" width="100%" height="920px" style="border:1px dashed black;">
</iframe>
<h1 id="how-is-it-working">1. How is it working?</h1>
<p>The computer learns by interacting with the game enviroment. Then it observes how the game environment changes, leading to its reward. By playing many many times, it gets the idea of receiving as many good rewards as possible. This type of learning is called <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Reinforcement_learning">Reinforcement Learning</a>.</p>
<p>If you want to learn more about it, there is a free ebook you should read, <a target="_blank" rel="noopener" href="https://web.stanford.edu/class/psych209/Readings/SuttonBartoIPRLBook2ndEd.pdf">Reinforcement Learning, Richard S. Sutton and Andrew G. Barto</a>.</p>
<p><img src="/images/2021-03-14/001.svg" /></p>
<p>Next, I'll walk you through the three algorithms and how to implement them.</p>
<ul>
<li>Monte Carlo</li>
<li>SARSA</li>
<li>Q-Learning</li>
</ul>
<p>Before the algorithms can interact with the game environment, we must have the game enviroment implemented first.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* game.js */</span></span><br><span class="line"><span class="keyword">import</span> &#123; every &#125; <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> X = <span class="string">&#x27;X&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> O = <span class="string">&#x27;O&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> EMPTY = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> initGame = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    turn: X,</span><br><span class="line">    winner: <span class="literal">null</span>,</span><br><span class="line">    gameover: <span class="literal">false</span>,</span><br><span class="line">    board: [EMPTY, EMPTY, EMPTY, EMPTY, EMPTY, EMPTY, EMPTY, EMPTY, EMPTY]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> move = <span class="function">(<span class="params">game, location</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; turn, board &#125; = game;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> validMoves = getValidMoves(board);</span><br><span class="line">  <span class="keyword">if</span> (!validMoves.includes(location)) &#123;</span><br><span class="line">    <span class="keyword">return</span> game;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> nextState = [...board];</span><br><span class="line">  nextState[location] = turn;</span><br><span class="line">  turn = turn === X ? O : X;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> winner = checkWinner(nextState);</span><br><span class="line">  <span class="keyword">const</span> gameover = checkGameover(nextState);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    turn,</span><br><span class="line">    winner,</span><br><span class="line">    gameover,</span><br><span class="line">    board: nextState</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getValidMoves = <span class="function">(<span class="params">board</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> validMoves = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; board.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (board[i] === EMPTY) validMoves.push(i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> validMoves;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> checkWinner = <span class="function">(<span class="params">board</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> lines = [</span><br><span class="line">    [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">3</span>, <span class="number">6</span>],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">4</span>, <span class="number">7</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">5</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>],</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; lines.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> [a, b, c] = lines[i];</span><br><span class="line">    <span class="keyword">if</span> (board[a] !== EMPTY &amp;&amp; board[a] === board[b] &amp;&amp; board[a] === board[c]) &#123;</span><br><span class="line">      <span class="keyword">return</span> board[a];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> checkGameover = <span class="function">(<span class="params">board</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> every(board, <span class="function"><span class="params">it</span> =&gt;</span> it !== EMPTY) || !!checkWinner(board);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> boardToString = <span class="function">(<span class="params">board</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> board.join(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> calculateReward = <span class="function">(<span class="params">game, player</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; gameover, winner &#125; = game;</span><br><span class="line">  <span class="keyword">if</span> (!gameover) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!winner) &#123;</span><br><span class="line">      <span class="comment">// Reward for a draw game</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (winner === player) &#123;</span><br><span class="line">      <span class="comment">// Reward for win</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Reward for lose</span></span><br><span class="line">      <span class="keyword">return</span> -<span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="monte-carlo">2. Monte Carlo</h1>
<h2 id="the-algorithm">The algorithm</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Initialize, for all s ∈ S, a ∈ A(s): </span><br><span class="line">    Q(s, a) ← arbitrary</span><br><span class="line">    π(s) ← arbitrary</span><br><span class="line">    Returns(s, a) ← empty list</span><br><span class="line"></span><br><span class="line">Repeat forever:</span><br><span class="line">    Choose S0 ∈ S and A0 ∈ A(S0) s.t. all pairs have probability &gt; 0 </span><br><span class="line">    Generate an episode starting from S0,A0, following π</span><br><span class="line">    For each pair s, a appearing in the episode:</span><br><span class="line">        G ← return following the first occurrence of s, a </span><br><span class="line">        Append G to Returns(s, a)</span><br><span class="line">        Q(s, a) ← average(Returns(s, a))</span><br><span class="line">    For each s in the episode: </span><br><span class="line">        π(s) ← argmax(Q(s, a))</span><br></pre></td></tr></table></figure>
<h2 id="implementation">Implementation</h2>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* MonteCarloAgent.js */</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MorteCarloAgent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">&#123; epsilon = <span class="number">0.1</span>, discount = <span class="number">0.9</span>, player = O &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.epsilon = epsilon;</span><br><span class="line">    <span class="built_in">this</span>.discount = discount;</span><br><span class="line">    <span class="built_in">this</span>.episode = [];</span><br><span class="line">    <span class="built_in">this</span>.player = player;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.Q = <span class="keyword">new</span> <span class="built_in">Proxy</span>(</span><br><span class="line">      &#123;&#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        get: <span class="function">(<span class="params">target, name</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(name <span class="keyword">in</span> target)) &#123;</span><br><span class="line">            target[name] = range(<span class="number">0</span>, <span class="number">9</span>, <span class="number">0.0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> target[name];</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.returnSums = <span class="keyword">new</span> <span class="built_in">Proxy</span>(</span><br><span class="line">      &#123;&#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        get: <span class="function">(<span class="params">target, name</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(name <span class="keyword">in</span> target)) &#123;</span><br><span class="line">            target[name] = range(<span class="number">0</span>, <span class="number">9</span>, <span class="number">0.0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> target[name];</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.returnCounts = <span class="keyword">new</span> <span class="built_in">Proxy</span>(</span><br><span class="line">      &#123;&#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        get: <span class="function">(<span class="params">target, name</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(name <span class="keyword">in</span> target)) &#123;</span><br><span class="line">            target[name] = range(<span class="number">0</span>, <span class="number">9</span>, <span class="number">0.0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> target[name];</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  policy = <span class="function">(<span class="params">game</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; board &#125; = game;</span><br><span class="line">    <span class="keyword">const</span> validMoves = getValidMoves(board);</span><br><span class="line">    <span class="keyword">const</span> boardString = boardToString(board);</span><br><span class="line">    <span class="keyword">let</span> A = range(<span class="number">0</span>, <span class="number">9</span>, <span class="number">0.0</span>);</span><br><span class="line">    <span class="keyword">const</span> cloned = clone(<span class="built_in">this</span>.Q[boardString]);</span><br><span class="line">    <span class="keyword">const</span> pulled = pullAt(cloned, validMoves);</span><br><span class="line">    <span class="keyword">const</span> bestScore = max(pulled);</span><br><span class="line">    <span class="keyword">const</span> bestAction = validMoves[pulled.indexOf(bestScore)];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; validMoves.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> a = validMoves[i];</span><br><span class="line">      A[a] = <span class="built_in">this</span>.epsilon / validMoves.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (validMoves.includes(bestAction)) &#123;</span><br><span class="line">      A[bestAction] += <span class="number">1.0</span> - <span class="built_in">this</span>.epsilon;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> someAction = sample(validMoves);</span><br><span class="line">      A[someAction] += <span class="number">1.0</span> - <span class="built_in">this</span>.epsilon;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> A;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  learn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> memory = <span class="built_in">this</span>.episode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (memory.length &gt; <span class="number">0</span> &amp;&amp; memory[memory.length - <span class="number">1</span>][<span class="number">0</span>].gameover) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; memory.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> record = memory[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> state = record[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">const</span> action = record[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> G = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> discount = <span class="built_in">this</span>.discount;</span><br><span class="line">        <span class="keyword">const</span> stateString = boardToString(state.board);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = i + <span class="number">1</span>; j &lt; memory.length; j++) &#123;</span><br><span class="line">          <span class="keyword">const</span> nextRecord = memory[j];</span><br><span class="line">          <span class="keyword">const</span> nextState = nextRecord[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">const</span> reward = calculateReward(nextState, <span class="built_in">this</span>.player);</span><br><span class="line">          G += reward * discount;</span><br><span class="line">          discount = discount * <span class="built_in">this</span>.discount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.returnSums[stateString][action] += G;</span><br><span class="line">        <span class="built_in">this</span>.returnCounts[stateString][action] += <span class="number">1.0</span>;</span><br><span class="line">        <span class="built_in">this</span>.Q[stateString][action] =</span><br><span class="line">          <span class="built_in">this</span>.returnSums[stateString][action] /</span><br><span class="line">          <span class="built_in">this</span>.returnCounts[stateString][action];</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  observe = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.episode.push([state, action]);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  newEpisode = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.episode = [];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="sarsa">3. SARSA</h1>
<h2 id="the-algorithm-1">The algorithm</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Initialize Q(s, a), ∀s ∈ S, a ∈ A(s), arbitrarily, and Q(terminal-state, ·) &#x3D; 0 </span><br><span class="line">Repeat (for each episode):</span><br><span class="line">    Initialize S</span><br><span class="line">    Choose A from S using policy derived from Q (e.g., ε-greedy) </span><br><span class="line">    Repeat (for each step of episode):</span><br><span class="line">        Take action A, observe R, S′</span><br><span class="line">        Choose A′ from S′ using policy derived from Q (e.g., ε-greedy) </span><br><span class="line">        Q(S, A) ← Q(S, A) + α[R + γQ(S′, A′) − Q(S, A)]</span><br><span class="line">        S ← S′; A ← A′;</span><br><span class="line">    until S is terminal</span><br></pre></td></tr></table></figure>
<h2 id="implementation-1">Implementation</h2>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SarsaAgent.js */</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">SarsaAgent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">&#123; epsilon = <span class="number">0.1</span>, discount = <span class="number">0.9</span>, alpha = <span class="number">0.01</span>, player = O &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.epsilon = epsilon;</span><br><span class="line">    <span class="built_in">this</span>.discount = discount;</span><br><span class="line">    <span class="built_in">this</span>.alpha = alpha;</span><br><span class="line">    <span class="built_in">this</span>.player = player;</span><br><span class="line">    <span class="built_in">this</span>.episode = [];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>._Q = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.Q = <span class="keyword">new</span> <span class="built_in">Proxy</span>(<span class="built_in">this</span>._Q, &#123;</span><br><span class="line">      get: <span class="function">(<span class="params">target, name</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(name <span class="keyword">in</span> target)) &#123;</span><br><span class="line">          target[name] = range(<span class="number">0</span>, <span class="number">9</span>, <span class="number">0.0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target[name];</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  policy = <span class="function">(<span class="params">game</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; board &#125; = game;</span><br><span class="line">    <span class="keyword">const</span> validMoves = getValidMoves(board);</span><br><span class="line">    <span class="keyword">const</span> boardString = boardToString(board);</span><br><span class="line">    <span class="keyword">let</span> A = range(<span class="number">0</span>, <span class="number">9</span>, <span class="number">0.0</span>);</span><br><span class="line">    <span class="keyword">const</span> cloned = clone(<span class="built_in">this</span>.Q[boardString]);</span><br><span class="line">    <span class="keyword">const</span> pulled = pullAt(cloned, validMoves);</span><br><span class="line">    <span class="keyword">const</span> bestScore = max(pulled);</span><br><span class="line">    <span class="keyword">const</span> bestAction = validMoves[pulled.indexOf(bestScore)];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; validMoves.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> a = validMoves[i];</span><br><span class="line">      A[a] = <span class="built_in">this</span>.epsilon / validMoves.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (validMoves.includes(bestAction)) &#123;</span><br><span class="line">      A[bestAction] += <span class="number">1.0</span> - <span class="built_in">this</span>.epsilon;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> someAction = sample(validMoves);</span><br><span class="line">      A[someAction] += <span class="number">1.0</span> - <span class="built_in">this</span>.epsilon;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> A;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  learn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> memory = <span class="built_in">this</span>.episode;</span><br><span class="line">    <span class="keyword">if</span> (memory.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> record1 = memory[memory.length - <span class="number">2</span>];</span><br><span class="line">      <span class="keyword">const</span> record2 = memory[memory.length - <span class="number">1</span>];</span><br><span class="line">      <span class="keyword">const</span> state = record1[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">const</span> action = record1[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">const</span> nextState = record2[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">const</span> nextAction = record2[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> reward = calculateReward(nextState, <span class="built_in">this</span>.player);</span><br><span class="line">      <span class="keyword">const</span> stateString = boardToString(state.board);</span><br><span class="line">      <span class="keyword">const</span> nextStateString = boardToString(nextState.board);</span><br><span class="line">      <span class="keyword">const</span> nextStateValue = nextState.gameover</span><br><span class="line">        ? <span class="number">0</span></span><br><span class="line">        : <span class="built_in">this</span>.Q[nextStateString][nextAction];</span><br><span class="line">      <span class="keyword">const</span> tdTarget = reward + <span class="built_in">this</span>.discount * nextStateValue;</span><br><span class="line">      <span class="keyword">const</span> tdDelta = tdTarget - <span class="built_in">this</span>.Q[stateString][action];</span><br><span class="line">      <span class="built_in">this</span>.Q[stateString][action] += <span class="built_in">this</span>.alpha * tdDelta;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  observe = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.episode.push([state, action]);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  newEpisode = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.episode = [];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="q-learning">4. Q-Learning</h1>
<h2 id="the-algorithm-2">The algorithm</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Initialize Q(s, a), ∀s ∈ S, a ∈ A(s), arbitrarily, and Q(terminal-state, ·) &#x3D; 0 </span><br><span class="line">Repeat (for each episode):</span><br><span class="line">    Initialize S</span><br><span class="line">    Repeat (for each step of episode):</span><br><span class="line">        Choose A from S using policy derived from Q (e.g., ε-greedy) </span><br><span class="line">        Take action A, observe R, S′</span><br><span class="line">        Q(S, A) ← Q(S, A) + α[R + γ*max(Q(S′, a)) − Q(S, A)] </span><br><span class="line">        S ← S′;</span><br><span class="line">    until S is terminal</span><br></pre></td></tr></table></figure>
<h2 id="implementation-2">Implementation</h2>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* QLearningAgent.js */</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">QLearningAgent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">&#123; epsilon = <span class="number">0.1</span>, discount = <span class="number">0.9</span>, alpha = <span class="number">0.01</span>, player = O &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.epsilon = epsilon;</span><br><span class="line">    <span class="built_in">this</span>.discount = discount;</span><br><span class="line">    <span class="built_in">this</span>.alpha = alpha;</span><br><span class="line">    <span class="built_in">this</span>.player = player;</span><br><span class="line">    <span class="built_in">this</span>.episode = [];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>._Q = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.Q = <span class="keyword">new</span> <span class="built_in">Proxy</span>(<span class="built_in">this</span>._Q, &#123;</span><br><span class="line">      get: <span class="function">(<span class="params">target, name</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(name <span class="keyword">in</span> target)) &#123;</span><br><span class="line">          target[name] = range(<span class="number">0</span>, <span class="number">9</span>, <span class="number">0.0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target[name];</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  policy = <span class="function">(<span class="params">game</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; board &#125; = game;</span><br><span class="line">    <span class="keyword">const</span> validMoves = getValidMoves(board);</span><br><span class="line">    <span class="keyword">const</span> boardString = boardToString(board);</span><br><span class="line">    <span class="keyword">let</span> A = range(<span class="number">0</span>, <span class="number">9</span>, <span class="number">0.0</span>);</span><br><span class="line">    <span class="keyword">const</span> cloned = clone(<span class="built_in">this</span>.Q[boardString]);</span><br><span class="line">    <span class="keyword">const</span> pulled = pullAt(cloned, validMoves);</span><br><span class="line">    <span class="keyword">const</span> bestScore = max(pulled);</span><br><span class="line">    <span class="keyword">const</span> bestAction = validMoves[pulled.indexOf(bestScore)];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; validMoves.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> a = validMoves[i];</span><br><span class="line">      A[a] = <span class="built_in">this</span>.epsilon / validMoves.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (validMoves.includes(bestAction)) &#123;</span><br><span class="line">      A[bestAction] += <span class="number">1.0</span> - <span class="built_in">this</span>.epsilon;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> someAction = sample(validMoves);</span><br><span class="line">      A[someAction] += <span class="number">1.0</span> - <span class="built_in">this</span>.epsilon;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> A;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  learn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> memory = <span class="built_in">this</span>.episode;</span><br><span class="line">    <span class="keyword">if</span> (memory.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> record1 = memory[memory.length - <span class="number">2</span>];</span><br><span class="line">      <span class="keyword">const</span> record2 = memory[memory.length - <span class="number">1</span>];</span><br><span class="line">      <span class="keyword">const</span> state = record1[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">const</span> action = record1[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">const</span> nextState = record2[<span class="number">0</span>];</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">const</span> reward = calculateReward(nextState, <span class="built_in">this</span>.player);</span><br><span class="line">      <span class="keyword">const</span> stateString = boardToString(state.board);</span><br><span class="line">      <span class="keyword">const</span> nextStateString = boardToString(nextState.board);</span><br><span class="line">      <span class="keyword">const</span> nextStateValue = nextState.gameover</span><br><span class="line">        ? <span class="number">0</span></span><br><span class="line">        : max(<span class="built_in">this</span>.Q[nextStateString]);</span><br><span class="line">      <span class="keyword">const</span> tdTarget = reward + <span class="built_in">this</span>.discount * nextStateValue;</span><br><span class="line">      <span class="keyword">const</span> tdDelta = tdTarget - <span class="built_in">this</span>.Q[stateString][action];</span><br><span class="line">      <span class="built_in">this</span>.Q[stateString][action] += <span class="built_in">this</span>.alpha * tdDelta;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  observe = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.episode.push([state, action]);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  newEpisode = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.episode = [];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hienhoang.ml/2021/02/01/year-end-2020/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Hien Hoang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/01/year-end-2020/" class="post-title-link" itemprop="url">Year End 2020</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-01 22:56:40" itemprop="dateCreated datePublished" datetime="2021-02-01T22:56:40+07:00">2021-02-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-02-02 00:25:21" itemprop="dateModified" datetime="2021-02-02T00:25:21+07:00">2021-02-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Living/" itemprop="url" rel="index"><span itemprop="name">Living</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Hey, how do you do? Hope you had a good time in 2020.</p>
<p><img src="/images/2021-02-01/004.jpg"></p>
<p>I’ve spent two days and one night at last weekend for the company trip to Ho Coc - Ho Tram in Ba Ria - Vung Tau, where I had a great time with my family and colleagues by attending many team building activities and the happy year end party. That was the occasion for us to release the stress, laugh and play, then to look back what we experienced and achieved through out the difficult year 2020 due to Covid-19.</p>
<p>The trip started early on Sat 30 Jan 2021, at 5am, with nearly 100 attendees, including me and my family. I wanted to introduce the sunshine as well as the ocean waves on the long beach to my little son, so I brought my wife and him along the trip. He just turned 8 months old and he had been so curious about everything in this world. I had also felt excited and looked forward to going there. That was the first time I came to Ho Tram beach.</p>
<p>After about 3 hours, we finally got there. YAY~ ..... BUT! We had to complete the team building activities designed by the tour company before we were free to do whatever we liked. Team building activities were action games on the beach that required the team players’ unity spirit, strength and strategy. I found those games interesting but they took lots of efforts to win. Everyone felt tired but satisfied after the games. Then we went to stay at a resort nearby, waiting for the Year End Party in the evening.</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/ZuCm-tahGbM?t=58" frameborder="0" loading="lazy" allowfullscreen></iframe></div>
<p>In the afternoon, I took my wife and little son to the beach to play on the sand under the warm sun. It was windy and the waves were big and strong, the water was cool, which seemed not to be an ideal condition for swimming or soaking. That was my son’s first time putting his little feet in the sea waves coming in and seeing the sand moving when the waves coming out.</p>
<p><img src="/images/2021-02-01/001.jpeg"></p>
<p>Like any other babies, he liked to play with water a lot. When the waves turned bigger, we moved to the dry place and built the sand castle. I was surprised that he didn’t put the sand in his mouth, such a smart guy haha. After a while, he fell asleep in his mommy’s arms. Looking my wife hugging him, laying on the chair under the beautiful golden sunshine, listening to the endless ocean waves, I found the peaceful and happiness from the bottom of my heart.</p>
<p><img src="/images/2021-02-01/002.jpeg"></p>
<p>At that time I understood what it meant by saying the time seemed to pause for a moment. We went back to our room as the sun started setting to the west, preparing for the Year End Party.</p>
<p>The purpose of the party was to flashback what happened in last year 2020, honoring those who contributed great values to the company, and cheer up with the music shows and delicious food at the same time. Unexpectedly, I was called to the stage and received two awards, which were <strong>The Best Trainer</strong> and The Promotion from a Senior Software Engineer to <strong>Principal Software Engineer</strong>. What a big surprised to me.</p>
<p><img src="/images/2021-02-01/003.jpeg"></p>
<p>What a meaningful company trip! My wife said that she had been very happy as well as proud of me. The party went on in the warm atmosphere that people sang, danced, laughed and drunk beers. My little son fell asleep in his mommy’s arms again. He seemed to prefer sleeping in the noisy places haha. So, as soon as we finished the meal, we went back to the room and rested. That were all for the first day of the trip, also the important one. Next day, we had breakfast at the resort’s restaurant. Then we checked out at 11:30am. Our trip ended.</p>
<p>To me, although that trip was short but it brought to me many unforgettable moments with family and friends. Life is full of unexpectation, and I’m happy with it. After the trip, Tet holiday is coming to town! I will update our new journeys and share to you guys soon~!</p>
<p>Thanks for reading up to this line!</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hienhoang.ml/2021/01/28/how-to-replace-environment-variables-in-a-file/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Hien Hoang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/28/how-to-replace-environment-variables-in-a-file/" class="post-title-link" itemprop="url">How to replace environment variables in a file</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-28 13:53:30" itemprop="dateCreated datePublished" datetime="2021-01-28T13:53:30+07:00">2021-01-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-02-01 22:53:22" itemprop="dateModified" datetime="2021-02-01T22:53:22+07:00">2021-02-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="load-environment-from-.env-file">1. Load environment from <code>.env</code> file</h1>
<ul>
<li><p>Let say we have a <code>.env</code> file: <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WEBSITE_URL=https://hienhoang.ml</span><br><span class="line">USERNAME=hienhoang</span><br><span class="line">PASSWORD=p@ssword</span><br></pre></td></tr></table></figure></p></li>
<li><p>Then run this script will load all environment variables to current shell terminal <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export $(grep -v &#x27;^#&#x27; .env | xargs)</span><br></pre></td></tr></table></figure></p></li>
<li><p>You can also unset variables using below script <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unset $(grep -v &#x27;^#&#x27; .env | sed -E &#x27;s/(.*)=.*/\1/&#x27; | xargs)</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h1 id="substitute-all-environment-variables-in-a-file">2. Substitute all environment variables in a file</h1>
<ul>
<li><p><code>template.yml</code> <figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">website:</span> $&#123;WEBSITE_URL&#125;</span><br><span class="line"><span class="symbol">username:</span> $&#123;USERNAME&#125;</span><br><span class="line"><span class="symbol">password:</span> $&#123;PASSWORD&#125;</span><br></pre></td></tr></table></figure></p></li>
<li><p>Run this script to substitute variable in the <code>template.yml</code> file and output to <code>config.yml</code> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">envsubst &lt; template.yml &gt; config.yml</span><br></pre></td></tr></table></figure></p></li>
<li><p>Result is the <code>config.yml</code> <figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">website:</span> <span class="symbol">https:</span>/<span class="regexp">/hienhoang.ml</span></span><br><span class="line"><span class="regexp">username: hienhoang</span></span><br><span class="line"><span class="regexp">password: p@ssword</span></span><br></pre></td></tr></table></figure></p></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hien Hoang</span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

  

</body>
</html>
